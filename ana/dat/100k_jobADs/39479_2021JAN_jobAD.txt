"datetime - Daily SQL job to delete records older than 24 hours - Code Review Stack ExchangeStack Exchange NetworkStack Exchange network consists of 176 Q&A communities including Stack Overflow, the largest, most trusted online community for developers to learn, share their knowledge, and build their careers.Visit Stack ExchangeLoading…0+0Tour Start here for a quick overview of the siteHelp Center Detailed answers to any questions you might haveMeta Discuss the workings and policies of this siteAbout Us Learn more about Stack Overflow the companyBusiness Learn more about hiring developers or posting ads with usLog in Sign upcurrent communityCode Reviewhelp chatCode Review Metayour communitiesSign up or log in to customize your list.more stack exchange communitiescompany blogCode Review Stack Exchange is a question and answer site for peer programmer code reviews. It only takes a minute to sign up.Sign up to join this communityAnybody can ask a questionAnybody can answerThe best answers are voted up and rise to the topHomeQuestionsTagsUsersUnansweredJobsDaily SQL job to delete records older than 24 hoursAsk QuestionAsked 1 year, 5 months agoActive 1 year, 5 months agoViewed 139 times31\\$\\begingroup\\$Below is a delete job to delete 1M+ records daily and takes 13 hours to complete and sometimes more than that. I need to optimize this.The table tblcalldatastore is being inserted 24*7 through a stored procedure and is supposed to have no records older than 24 hours.Execution plan is below.https://www.brentozar.com/pastetheplan/?id=ryYi2Sv7BBEGIN      SET NOCOUNT ON;      DECLARE @DELETECOUNT int      DECLARE @DELETEATATIME int      DECLARE @CutOffDate datetime      DECLARE @HourRetained smallint      set @HourRetained = 24      begin Try      set @CutOffDate = getutcdate()      select  @DELETECOUNT = count(*) from [tblcalldatastore]      where  istestcase=0      and datediff(hour,receiveddate,@CutOffDate)>@HourRetained      SET @DELETEATATIME = 20000      WHILE @DELETECOUNT > 0      BEGIN      DELETE TOP(@DELETEATATIME) FROM tblcalldatastore WITH (ROWLOCK)  WHERE IsTestCase=0 and datediff(hour,receiveddate,@CutOffDate)>@HourRetained       SET @DELETECOUNT = @DELETECOUNT - @DELETEATATIME       END      end try      BEGIN CATCH      SELECT 'FAILED - ' + ERROR_MESSAGE() AS ErrorMessage      END CATCH      END      sql datetime time-limit-exceeded sql-server t-sqlShareImprove this questionFollowedited Aug 6 '19 at 19:31Andyasked Aug 6 '19 at 18:51AndyAndy4344 bronze badges\\$\\endgroup\\$\\$\\begingroup\\$ Are you retaining more data than you delete, and which is the ratio of retained/deleted? \\$\\endgroup\\$ – dfhwze Aug 6 '19 at 18:562\\$\\begingroup\\$ Please ensure that your code is posted with the intended formatting. There seems to be a lot of code here that isn't correctly commented out. \\$\\endgroup\\$ – 200_success Aug 6 '19 at 19:073\\$\\begingroup\\$ Also tell us more about exactly what this code is designed to accomplish, and what the schema looks like. It's hard to help you without that background information. See How to Ask. \\$\\endgroup\\$ – 200_success Aug 6 '19 at 19:071\\$\\begingroup\\$ @200_success - I have updated the code. The code is designed to delete any record older than 24 hours on daily basis. \\$\\endgroup\\$ – Andy Aug 6 '19 at 19:191\\$\\begingroup\\$ I'd suggest creating a smaller database to test the exact workings of your query on and note the inefficiencies. This will allow you to test alternative implementations a lot easier and faster. \\$\\endgroup\\$ – Mast Aug 7 '19 at 5:44| show 7 more comments1 Answer 1Active Oldest Votes1\\$\\begingroup\\$From CommentsHave you tested performance of copying data of a single day to a temporary table, truncating the target table, and re-inserting the copied data back to the target table?Yes, it's not taking much time to copy or insert, it is taking time to delete and select. One of the column has huge XML string.Proposed SolutionSince inserting and copying data does not seem to yield a performance penalty, I would suggest to:copy to data of today to a staging tabletruncate the existing table (much faster than delete, no transaction logs)copy staged data back to existing tableOr alternatively, as Dannnno suggests:Potentially faster than copying the data twice would be to copy data to a staging table, truncate the existing table, then rename them both to swap places. This minimizes latches required for DDL, and also only requires a single copy. Snapshot isolation would also help this be as non-invasive as possible for anyone hitting the database.LinksSimilar problem: non-clustered index bottleneck on deleteEnlists a couple of possible solutionsShareImprove this answerFollowedited Aug 22 '19 at 15:03answered Aug 6 '19 at 19:37dfhwzedfhwze13.6k33 gold badges2929 silver badges9797 bronze badges\\$\\endgroup\\$1\\$\\begingroup\\$ The solution seems perfect to me! All I need is to find out best possible time slot when the Production is not in use. \\$\\endgroup\\$ – Andy Aug 6 '19 at 19:441\\$\\begingroup\\$ Potentially faster than copying the data twice would be to copy data to a staging table, truncate the existing table, then rename them both to swap places. This minimizes latches required for DDL, and also only requires a single copy. Snapshot isolation would also help this be as non-invasive as possible for anyone hitting the database. \\$\\endgroup\\$ – Dan Obermiller Aug 22 '19 at 14:55\\$\\begingroup\\$ @Dannnno Can I include your suggestion in my answer as an alternative option? Or you want to make an answer yourself? \\$\\endgroup\\$ – dfhwze Aug 22 '19 at 14:56\\$\\begingroup\\$ Feel free to include it yourself; it doesn't add a whole lot of additional information \\$\\endgroup\\$ – Dan Obermiller Aug 22 '19 at 15:011\\$\\begingroup\\$ @Dannnno I added it because comments can get removed, thanks for sharing your views. \\$\\endgroup\\$ – dfhwze Aug 22 '19 at 15:03add a comment |Your AnswerThanks for contributing an answer to Code Review Stack Exchange!Please be sure to answer the question. Provide details and share your research!But avoid …Asking for help, clarification, or responding to other answers.Making statements based on opinion; back them up with references or personal experience.Use MathJax to format equations. MathJax reference.To learn more, see our tips on writing great answers.Draft savedDraft discardedSign up or log inSign up using GoogleSign up using FacebookSign up using Email and PasswordSubmitPost as a guestNameEmailRequired, but never shownPost as a guestNameEmailRequired, but never shownPost Your AnswerDiscardBy clicking “Post Your Answer”, you agree to our terms of service, privacy policy and cookie policyNot the answer you're looking for? Browse other questions tagged sql datetime time-limit-exceeded sql-server t-sql or ask your own question.The Overflow BlogPodcast 305: What does it mean to be a “senior” software engineerEpisode 304: Our stack is HTML and CSSLinked3Deleting millions of logs in batchesRelated3Shifting records in SQL Database while sorting with algorithm8Generate random records for table in SQL5PostgreSQL multiple processes and queries or nested query2Job execution on records supplied by database19Find & Delete Duplicate Records on All Tables in current MSSQL Database2SQL Inserting up to 10'000 records from a table to a secondary table3Grabbing SQL records: Nullable bool to bool8SQL trigger to log when employee records are updated3SQL Query - records within the last year1T-SQL query Choose name of clients, concluded more than one loan agreement in 2010Hot Network QuestionsMaximum useful resolution for scanning 35mm filmHow to use a shared pointer of a pure abstract class without using reset and new?Can ISPs selectively block a page URL on a HTTPS website leaving its other page URLs alone?Photochemical reduction of benzophenone: why inverted flask?What is the highest road in the world that is accessible by conventional vehicles?I'm not seeing 'tightly coupled code' as one of the drawbacks of a monolithic application architectureCan an Eldritch Knight use a Ruby of the War Mage?SQL Server Long Running Transaction - WAITFOR(RECEIVE conversation....DatabaseMail)Why is it so hard to build crewed rockets/spacecraft able to reach escape velocity?Advice for first electric guitarStar Trek TOS aliens won’t fightHow can a GM subtly guide characters into making campaign-specific character choices?How do I install a light socket in the middle of a power line with a switch?Can I make a leisure trip to California (vacation) in the current covid-19 situation as of 2021, will my quarantine be monitored?Where is the antenna in this remote control board?Which countries' inheritance laws apply?Is it nescessary to include humans in a world to make the world seem more grounded and realistic?Bash - How to reorganize files based on the dates in their names?At whose expense is the stage of preparing a contract performed?What does the ^ character mean in sequences like ^X^I?Chain Puzzle: Video Games #01 - Teleporting Crosswords!How to make a realistic Pepsi material?How four wires are replaced with two wires in early telephone?Caught someone's salary receipt open in its respective personal webmail in someone else's computer. What to do?more hot questionsQuestion feedSubscribe to RSSQuestion feedTo subscribe to this RSS feed, copy and paste this URL into your RSS reader.lang-sqlCode ReviewTourHelpChatContactFeedbackMobileCompanyStack OverflowFor TeamsAdvertise With UsHire a DeveloperDeveloper JobsAboutPressLegalPrivacy PolicyTerms of ServiceStack ExchangeNetworkTechnologyLife / ArtsCulture / RecreationScienceOtherStack OverflowServer FaultSuper UserWeb ApplicationsAsk UbuntuWebmastersGame DevelopmentTeX - LaTeXSoftware EngineeringUnix & LinuxAsk Different (Apple)WordPress DevelopmentGeographic Information SystemsElectrical EngineeringAndroid EnthusiastsInformation SecurityDatabase AdministratorsDrupal AnswersSharePointUser ExperienceMathematicaSalesforceExpressionEngine® AnswersStack Overflow em PortuguêsBlenderNetwork EngineeringCryptographyCode ReviewMagentoSoftware RecommendationsSignal ProcessingEmacsRaspberry PiStack Overflow на русскомCode GolfStack Overflow en españolEthereumData ScienceArduinoBitcoinSoftware Quality Assurance & TestingSound DesignWindows Phonemore (28)PhotographyScience Fiction & FantasyGraphic DesignMovies & TVMusic: Practice & TheoryWorldbuildingVideo ProductionSeasoned Advice (cooking)Home ImprovementPersonal Finance & MoneyAcademiaLawPhysical FitnessGardening & LandscapingParentingmore (10)English Language & UsageSkepticsMi Yodeya (Judaism)TravelChristianityEnglish Language LearnersJapanese LanguageChinese LanguageFrench LanguageGerman LanguageBiblical HermeneuticsHistorySpanish LanguageIslamРусский языкRussian LanguageArqade (gaming)BicyclesRole-playing GamesAnime & MangaPuzzlingMotor Vehicle Maintenance & RepairBoard & Card GamesBricksHomebrewingMartial ArtsThe Great OutdoorsPokerChessSportsmore (16)MathOverflowMathematicsCross Validated (stats)Theoretical Computer SciencePhysicsChemistryBiologyComputer SciencePhilosophyLinguisticsPsychology & NeuroscienceComputational Sciencemore (10)Meta Stack ExchangeStack AppsAPIDataBlogFacebookTwitterLinkedInInstagramsite design / logo © 2021 Stack Exchange Inc; user contributions licensed under cc by-sa. rev 2021.1.18.38333Code Review Stack Exchange works best with JavaScript enabled"
